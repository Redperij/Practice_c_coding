#pragma warning(disable:4996) //disabling warning

/*
You need to write two functions:

Function called //register_slip_frame_callback that takes one parameter:
pointer to a function that takes a const unsigned char pointer and an integer as parameters and returns no value.
register_slip_frame_callback does not return a value.
The function stores the callback function pointer to a global variable.

Function called process_slip_data that takes one parameter:
pointer to a function that does not take any parameters and returns an integer.
Process_slip_data does not return a value.

Process_slip_data uses the function given as parameter to read bytes that carry SLIP framed data.
The function reads and decodes data until the reader function return EOF to indicate end of input.
The data that reader function returns contains SLIP framed data where the maximum data length is 40 bytes.
Note that because of escaping the number of received bytes before frame is completetely received can be much longer (82 bytes in the worst case before decoding).
The length of decoded data never exceed 40 bytes. When a frame is completely received (SLIP_END received) then data is passed to the callback function for processing.
If two SLIP_ENDs are received with no data between them the callback function is not called because there is no data to process.

The test bench first registers a callback function and then calls process_slip_data. Both callback function and reader function are implemented in the test bench.
*/

//NON-TASK

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdarg.h>
#include <ctype.h>
#include <stdbool.h>
#include <stdint.h>

#define SLIP_END 0xC0
#define SLIP_ESC 0xDB
#define SLIP_ESC_END 0xDC
#define SLIP_ESC_ESC 0xDD

int read_byte = -1;

int bytes[] = { 0xC0, 0x8C, 0xA9, 0x87, 0x8C, 0xF1, 0x1D, 0x95, 0x9B, 0xDB, 0xDC, 0xE9, 0x9A, 0x86, 0xB5, 0xBF, 0xE7, 
0x23, 0x55, 0x38, 0xD1, 0x6C, 0xDB, 0xDD, 0x5E, 0xE1, 0x9C, 0xD9, 0xDB, 0xDD, 0xE2, 0xE2, 0x9B, 0x47, 0x38, 0x46, 
0xA9, 0xC0, 0xC0, 0x7A, 0x78, 0x63, 0x26, 0xDA, 0x6D, 0x62, 0x96, 0x34, 0x39, 0x3F, 0x5E, 0x6D, 0xE3, 0x28, 0x1E, 
0xDB, 0xDC, 0xCB, 0x03, 0x41, 0x84, 0x14, 0xDB, 0xDD, 0xDB, 0xDD, 0x28, 0xC9, 0xE7, 0xC0, 0xC0, 0x46, 0x08, 0xDB, 
0xDC, 0xA8, 0xFE, 0xF2, 0x71, 0xA0, 0x3B, 0x06, 0xDB, 0xDC, 0x87, 0x73, 0xC0, 0xC0, 0xBE, 0xBE, 0xC2, 0x41, 0x8C, 
0x30, 0xC0, 0xC0, 0xF0, 0x54, 0x32, 0xAA, 0x68, 0x0B, 0xFC, 0xCA, 0x7D, 0x89, 0x41, 0xFD, 0x4F, 0xDB, 0xDC, 0x72, 
0x14, 0xCD, 0x0D, 0x44, 0xB4, 0x66, 0x33, 0xCB, 0x10, 0x4C, 0x03, 0xDB, 0xDC, 0xE6, 0xB4, 0x0E, 0xAD, 0xD5, 0xDB, 
0xDC, 0x27, 0xD8, 0x14, 0xF4, 0x27, 0xDB, 0xDD, 0x7C, 0xC0, 0xC0, 0xF8, 0x8C, 0x20, 0x64, 0xA6, 0x95, 0xB0, 0x8D, 
0x2D, 0xE7, 0xB1, 0xDE, 0x80, 0x08, 0xE9, 0x41, 0xD5, 0xE4, 0x9F, 0x42, 0x26, 0x4C, 0x21, 0x93, 0xB3, 0x73, 0x40, 
0x8A, 0x7E, 0xC0, 0xC0, 0xD5, 0xD3, 0x95, 0x5A, 0x65, 0x2A, 0x07, 0xDB, 0xDD, 0xBE, 0xA6, 0xC9, 0x69, 0x34, 0xDB, 
0xDD, 0xDB, 0xDC, 0x01, 0x17, 0xC6, 0x9D, 0xA6, 0x0B, 0x81, 0xDB, 0xDC, 0x6B, 0x12, 0xF9, 0xD0, 0x71, 0x48, 0x0D, 
0x29, 0x86, 0x99, 0xDB, 0xDD, 0xDB, 0xDC, 0xC0, 0xC0, 0x4F, 0xB8, 0xB0, 0xDB, 0xDD, 0xF5, 0xC0, 0xC0, 0x6C, 0x8D, 
0xD9, 0x43, 0xDB, 0xDD, 0x08, 0xF6, 0xDB, 0xDD, 0xF7, 0x15, 0xE0, 0xDB, 0xDD, 0x8F, 0x3C, 0xF4, 0x62, 0xC0, 0xC0, 
0x8F, 0x5C, 0xE5, 0x4A, 0x32, 0x61, 0xDB, 0xDC, 0xC6, 0xB1, 0x30, 0x10, 0x75, 0x03, 0x9E, 0xEF, 0x50, 0xC8, 0x43, 
0x28, 0xC0, 0xC0, 0xE9, 0x47, 0x81, 0x31, 0xDB, 0xDC, 0xA4, 0xDE, 0xDB, 0xDD, 0x8C, 0x10, 0x9A, 0xCD, 0x57, 0x50, 
0xBF, 0x1C, 0x03, 0x7F, 0x89, 0xB9, 0xDB, 0xDD, 0x4E, 0x3C, 0xDB, 0xDD, 0x02, 0x42, 0x0D, 0xC0, 0xC0, 0x14, 0xBB, 
0x2F, 0xE2, 0xC0, 0xC0, 0x7D, 0xD8, 0xD3, 0x01, 0x50, 0x16, 0x43, 0x83, 0xDB, 0xDD, 0x18, 0x2B, 0x2E, 0xF9, 0xDC, 
0xF0, 0x0E, 0x6D, 0x31, 0x74, 0x8D, 0xA4, 0xD5, 0x6A, 0xFC, 0x76, 0x4B, 0xC0, 0xC0, 0x36, 0xDB, 0xDD, 0xDB, 0xDD, 
0x5A, 0x72, 0x82, 0x71, 0x8C, 0x5E, 0x4E, 0xFA, 0xB0, 0x74, 0x75, 0xDC, 0xDB, 0xDC, 0xC0, 0xC0, 0xDA, 0xC0, 0xC0, 
0x81, 0x7F, 0xCB, 0x36, 0xDB, 0xDD, 0x74, 0x55, 0xAC, 0x0B, 0xA9, 0x23, 0xC0, 0xC0, 0xA3, 0xB9, 0xDB, 0xDD, 0x68, 
0xE1, 0xD5, 0x32, 0x0A, 0xDB, 0xDD, 0xC0, 0xC0, 0xE9, 0x5D, 0xB5, 0xC5, 0x6C, 0x98, 0x57, 0x87, 0xDF, 0x68, 0xA2, 
0xE6, 0xC6, 0xDB, 0xDC, 0x5F, 0xDB, 0xDD, 0x8F, 0x2A, 0x14, 0xD4, 0x11, 0x18, 0xDB, 0xDD, 0xBB, 0x1C, 0xCA, 0xDB, 
0xDC, 0x5D, 0x2F, 0x53, 0xD7, 0x59, 0x0D, 0x26, 0x55, 0xC0, 0xC0, 0xDB, 0xDC, 0xD9, 0xF8, 0xB8, 0xDB, 0xDD, 0x7A, 
0x5C, 0xC0, 0xC0, 0x9F, 0xDB, 0xDD, 0x3C, 0x85, 0x81, 0x7D, 0xEE, 0xC0, 0xC0, 0x85, 0x12, 0x8B, 0xEC, 0xE2, 0xF3, 
0xDB, 0xDD, 0x90, 0x32, 0xF4, 0x02, 0x2C, 0x1E, 0x74, 0x43, 0x0B, 0x37, 0x92, 0x53, 0xB5, 0x3E, 0x0E, 0xFB, 0x46, 
0x26, 0x7E, 0x7A, 0xED, 0x97, 0xCA, 0x02, 0x6C, 0xDB, 0xDC, 0x3F, 0xC0, 0xC0, 0x3A, 0xDB, 0xDC, 0xDF, 0x5F, 0xDD, 
0xB9, 0x1B, 0xA6, 0x1D, 0xE5, 0xDB, 0xDC, 0xDB, 0xDC, 0xDB, 0xDC, 0x4A, 0xC3, 0x59, 0x0E, 0x0A, 0xC4, 0xBE, 0xE3, 
0x01, 0xFF, 0xB2, 0x89, 0x65, 0x51, 0x05, 0x4A, 0xBE, 0x8D, 0x19, 0xA1, 0xC0, 0xC0, 0xD4, 0x04, 0xED, 0xC9, 0x14, 
0x3F, 0xF2, 0x68, 0xDB, 0xDD, 0xDB, 0xDC, 0xEC, 0x94, 0xEC, 0x69, 0xDB, 0xDC, 0x83, 0x63, 0xDB, 0xDD, 0xE3, 0xDD, 
0x58, 0x4F, 0x38, 0xFD, 0xC5, 0xDB, 0xDC, 0x65, 0x69, 0x30, 0xAF, 0xE2, 0xB6, 0x4B, 0x00, 0x2F, 0x84, 0x54, 0x5F, 
0xDB, 0xDC, 0xC0, 0xC0, 0xC5, 0xCB, 0x3D, 0xF3, 0x0E, 0xF2, 0xDB, 0xDD, 0x98, 0x74, 0x22, 0x58, 0x74, 0xEF, 0x54, 
0xDF, 0x39, 0xE6, 0xDB, 0xDC, 0x1C, 0x74, 0xFE, 0x9D, 0x6E, 0x48, 0x44, 0x3E, 0xB8, 0xDB, 0xDC, 0xB6, 0x22, 0xE4, 
0xDD, 0x7B, 0x3D, 0x5C, 0xC0, 0xC0, 0x67, 0x2F, 0xFF, 0xCC, 0x13, 0xA9, 0x11, 0xAD, 0x41, 0xDB, 0xDD, 0x28, 0x62, 
0xB8, 0xFD, 0xDB, 0xDD, 0x2B, 0x51, 0x80, 0x2E, 0xDB, 0xDD, 0x39, 0xAA, 0x1C, 0xDB, 0xDD, 0x77, 0x57, 0xD3, 0x17, 
0x4E, 0x32, 0x0F, 0x10, 0xC0, 0xC0, 0x2D, 0xDB, 0xDC, 0x26, 0xA2, 0xD8, 0xD1, 0xAF, 0x21, 0x59, 0xDE, 0xA6, 0x65, 
0xC0, 0xC0, 0x47, 0x21, 0xDD, 0xA2, 0x99, 0xDB, 0xDC, 0xDB, 0xDC, 0x34, 0x20, 0xC7, 0x4F, 0x84, 0xA0, 0x69, 0x22, 
0x24, 0x18, 0x28, 0xA9, 0x01, 0xD9, 0xE4, 0xB8, 0x8B, 0xC0, 0xC0, 0xC3, 0xDB, 0xDC, 0x06, 0x37, 0xDB, 0xDC, 0x83, 
0x0C, 0x83, 0x23, 0x44, 0x5C, 0x18, 0x30, 0xE1, 0x34, 0x77, 0x9A, 0x4A, 0xFB, 0x49, 0x54, 0x02, 0x4E, 0x0A, 0xC2, 
0x9F, 0x7C, 0x8C, 0x3F, 0x4D, 0x0A, 0x74, 0x9A, 0x4B, 0xDB, 0xDD, 0xC0, 0xC0, 0xBB, 0x94, 0x6C, 0xDB, 0xDD, 0x9D, 
0x9C, 0xDB, 0xDC, 0x98, 0xA8, 0xDB, 0xDC, 0x98, 0x48, 0xDB, 0xDC, 0x6E, 0xF1, 0xA1, 0x0E, 0xC0, 0xFF, EOF };
int read_bytes();

void callback(unsigned char *ip_frame, int size);

void register_slip_frame_callback(void (*callback_func)(unsigned char *, int));

void process_slip_data(int (*read_bytes)());

int main(int arcg, char **argv)
{
	register_slip_frame_callback(callback);
	process_slip_data(read_bytes);
	return 0;
}

//TASK
#define MAX_PSIZE 40

void(*my_callback)(unsigned char *, int);

void register_slip_frame_callback(void (*callback_func)(unsigned char *, int)) {
	my_callback = callback_func;
}

void process_slip_data(int (*read_bytes)()) {
	unsigned char processed_data[MAX_PSIZE] = { 0 };
	int byte = 0;
	int prev_byte = 0;
	int end_count = 0;
	int new_size = 0;

	while (byte != EOF) {
		end_count = 0;
		new_size = 0;
		while (end_count < 2 && byte != EOF) {
			byte = read_bytes();
			switch (byte)
			{
			case EOF:
				break;
			case SLIP_END:
				prev_byte = byte;
				end_count++;
				break;
			case SLIP_ESC:
				prev_byte = byte;
				break;
			case SLIP_ESC_END:
				if (prev_byte == SLIP_ESC) {
					processed_data[new_size] = SLIP_END;
					new_size++;
				}
				else {
					processed_data[new_size] = SLIP_ESC_END;
					new_size++;
				}
				prev_byte = byte;
				break;
			case SLIP_ESC_ESC:
				if (prev_byte == SLIP_ESC) {
					processed_data[new_size] = SLIP_ESC;
					new_size++;
				}
				else {
					processed_data[new_size] = SLIP_ESC_ESC;
					new_size++;
				}
				prev_byte = byte;
				break;
			default:
				processed_data[new_size] = byte;
				prev_byte = byte;
				new_size++;
				break;
			}
		}
		if (new_size) {
			my_callback(processed_data, new_size);
		}
	}
}

//NON-TASK

int read_bytes() {
	read_byte++;
	return bytes[read_byte];
}

void callback(unsigned char *ip_frame, int size) {
	for (int i = 0; i < size; i++) {
		printf("%02x ", ip_frame[i]);
	}
	printf("\n");
	return;
}